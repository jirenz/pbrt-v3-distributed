FROM ubuntu:16.04

RUN apt-get update && \
	apt-get install -yq build-essential gcc g++ cmake make bison flex curl git wget python3 python3-pip

RUN wget -nv https://download.opensuse.org/repositories/network:messaging:zeromq:release-stable/xUbuntu_16.04/Release.key -O Release.key

RUN apt-key add - < Release.key

RUN sh -c "echo 'deb http://download.opensuse.org/repositories/network:/messaging:/zeromq:/release-stable/xUbuntu_16.04/ /' > /etc/apt/sources.list.d/network:messaging:zeromq:release-stable.list" 

RUN apt-get update && apt-get install -y libzmq3-dev

RUN pip3 install awscli --upgrade --user

WORKDIR /app
COPY cmake /app/cmake
COPY src /app/src
COPY CMakeLists.txt /app/CMakeLists.txt
COPY LICENSE.txt /app/LICENSE.txt
COPY README.md /app/README.md
WORKDIR /app/build
ENV LD_LIBRARY_PATH=$LD_LIBRARY_PATH:/usr/local/lib
RUN cmake -G 'Unix Makefiles' .. && make -j4 install
COPY python-scheduler /app/python-scheduler
RUN pip3 install -e /app/python-scheduler/
ENV PATH=/root/.local/bin:/app/build:${PATH}

RUN mkdir -p /app/cloudrt && mkdir -p /app/cloudrt/pbrt
COPY entry.py /app/entry.py
ENTRYPOINT ["/app/entry.py"]