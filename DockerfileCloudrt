FROM ubuntu:18.10

RUN apt-get update && \
	apt-get install -yq build-essential gcc g++ cmake make bison flex curl git wget python3 python3-pip

RUN wget -nv https://download.opensuse.org/repositories/network:messaging:zeromq:release-stable/xUbuntu_18.10/Release.key -O Release.key

RUN apt-key add - < Release.key

RUN sh -c "echo 'deb http://download.opensuse.org/repositories/network:/messaging:/zeromq:/release-stable/xUbuntu_18.10/ /' > /etc/apt/sources.list.d/network:messaging:zeromq:release-stable.list" 

RUN apt-get update && apt-get install -y \
    libcrypto++-dev \
    libssl-dev \
    libunwind-dev \
    liblzma-dev \
    libprotobuf-dev \
    protobuf-compiler \
	libzmq5 \
	libzmq5-dev
# libpgm-dev

RUN pip3 install awscli --upgrade --user

WORKDIR /app
COPY cmake /app/cmake
COPY src /app/src
COPY CMakeLists.txt /app/CMakeLists.txt
COPY LICENSE.txt /app/LICENSE.txt
COPY README.md /app/README.md
COPY .git /app/.git
COPY .gitmodules /app/.gitmodules
RUN rm -rf /app/build
WORKDIR /app/build
ENV LD_LIBRARY_PATH=$LD_LIBRARY_PATH:/usr/local/lib
RUN cmake -G 'Unix Makefiles' .. 
WORKDIR /app/build/src/messages/
RUN make -j$(nproc)
WORKDIR /app/build
RUN make -j$(nproc)
RUN make install
COPY python-scheduler /app/python-scheduler
RUN pip3 install -e /app/python-scheduler/
ENV PATH=/root/.local/bin:/app/build:${PATH}

RUN mkdir -p /app/cloudrt && mkdir -p /app/cloudrt/pbrt
COPY entry.py /app/entry.py
ENTRYPOINT ["/app/entry.py"]