FROM ubuntu:18.10

RUN apt-get update && \
	apt-get install -yq build-essential gcc g++ cmake make bison flex curl git wget python3 python3-pip

RUN wget -nv https://download.opensuse.org/repositories/network:messaging:zeromq:release-stable/xUbuntu_18.10/Release.key -O Release.key

RUN apt-key add - < Release.key

RUN sh -c "echo 'deb http://download.opensuse.org/repositories/network:/messaging:/zeromq:/release-stable/xUbuntu_18.10/ /' > /etc/apt/sources.list.d/network:messaging:zeromq:release-stable.list" 

RUN apt-get update && apt-get install -y \
	libzmq3-dev \
	libcrypto++-dev \
	libssl-dev \
	libunwind-dev \
	liblzma-dev \
	libprotobuf-dev \
	protobuf-compiler


RUN pip3 install awscli --upgrade --user

WORKDIR /protobuf
RUN wget https://github.com/protocolbuffers/protobuf/releases/download/v3.6.1/protobuf-cpp-3.6.1.tar.gz \
	&& tar -xvzf protobuf-cpp-3.6.1.tar.gz \
	&& rm protobuf-cpp-3.6.1.tar.gz
WORKDIR /protobuf/protobuf-3.6.1
RUN ./configure 
RUN make
RUN make check
RUN make install
RUN ldconfig

WORKDIR /app
COPY cmake /app/cmake
COPY src /app/src
COPY CMakeLists.txt /app/CMakeLists.txt
COPY LICENSE.txt /app/LICENSE.txt
COPY README.md /app/README.md
WORKDIR /app/build
ENV LD_LIBRARY_PATH=$LD_LIBRARY_PATH:/usr/local/lib
RUN cmake -G 'Unix Makefiles' .. 
RUN make
RUN make install
COPY python-scheduler /app/python-scheduler
RUN pip3 install -e /app/python-scheduler/
ENV PATH=/root/.local/bin:/app/build:${PATH}

RUN mkdir -p /app/cloudrt && mkdir -p /app/cloudrt/pbrt
COPY entry.py /app/entry.py
ENTRYPOINT ["/app/entry.py"]